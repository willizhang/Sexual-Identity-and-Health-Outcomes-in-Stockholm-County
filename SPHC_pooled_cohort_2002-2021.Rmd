---
title: "Sexual identity and health outcomes in Stockholm County, SPHC 2002 to 2021"
author: Willi Zhang
email: willi.zhang@ki.se
output: html_notebook
editor_options: 
  chunk_output_type: console
---

### 1. Load Packages
```{r}
library(haven)
library(tidyr)
library(tidyverse)
library(dplyr)
library(finalfit)
library(lubridate)
library(stringr)
library(ggplot2)
library(naniar)
library(jomo)
library(mitml)
library(mitools)
library(survey)
library(vcd)
library(rcompanion)
source('Helper_functions.R') # helper function
```

### 2. Import and Prepare Data
```{r}
# determine follow-up period
migration_date <- read_sas('/Volumes/LGBT Project data/Registry-based health outcomes/migration_all.sas7bdat')
str( migration_date )
summary( migration_date )
length( unique( migration_date$lopnr ) ) # 12409 had any moving-in/-out

subset_data <- migration_date %>%
  filter( lopnr %in% unique( lopnr )[ 1:5000 ]) %>%
  arrange( lopnr, migrationdate )

segments <- subset_data %>%
  group_by( lopnr ) %>%
  mutate(
    next_event = lead( Posttyp ),
    next_date = lead( migrationdate ),
    start_date = case_when(
      row_number() == 1 & Posttyp == "Utv" ~ as.Date( "1990-01-08" ),  # start at 1990-01-08 if first event is Utv
      TRUE ~ migrationdate
    ),
    end_date = case_when(
      row_number() == 1 & Posttyp == "Utv" ~ migrationdate,
      Posttyp == "Inv" & !is.na( next_date ) & next_event == "Utv" ~ next_date,
      Posttyp == "Inv" & ( is.na( next_date ) | next_event != "Utv" ) ~ as.Date( "2021-12-30" ),
      TRUE ~ NA_Date_
    )
  ) %>%
  filter( !is.na( end_date ) ) %>%
  ungroup()

ggplot( segments, aes( y = factor( lopnr ) ) ) +
  geom_segment(
    aes( x = start_date, xend = end_date, yend = factor( lopnr ) ),
    color = "blue", size = 0.5
  ) +
  labs(
    title = "Follow-Up Periods by Individual",
    x = "Year",
    y = NULL
  ) +
  theme_classic() +
  theme(
    axis.text.y = element_blank(),  # Remove y-axis ticks
    axis.ticks.y = element_blank(),  # Remove y-axis tick marks
    axis.line.y = element_blank(),  # Remove y-axis line
    plot.title = element_text(size = 14, hjust = 0),  # Center the title
    axis.title.x = element_text(size = 12),
    axis.text.x = element_text(size = 10)
  )


# Prepare the data
heatmap_data <- segments %>%
  mutate(
    presence = 1  # Indicate presence in the system
  ) %>%
  group_by(lopnr, start_date, end_date) %>%
  summarize(
    date = seq.Date(start_date, end_date, by = "day"),  # Expand to daily presence
    .groups = "drop"
  ) %>%
  unnest(cols = c(date)) %>%  # Flatten the data
  group_by(lopnr, date) %>%
  summarize(
    presence = 1,  # Set presence for each day
    .groups = "drop"
  )

# Create the heatmap
ggplot(heatmap_data, aes(x = date, y = factor(lopnr), fill = presence)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue", na.value = "white") +
  labs(
    title = "Presence in the System Over Time",
    x = "Year",
    y = "Individual ID",
    fill = "Presence"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),  # Remove y-axis text
    axis.ticks.y = element_blank(),  # Remove y-axis ticks
    panel.grid = element_blank()  # Remove grid lines
  )
```

```{r}
x <- read_sas('/Volumes/projects/LGBT Project data/Registry-based health outcomes/first_immigration.sas7bdat')
y <- read_sas('/Volumes/projects/LGBT Project data/Registry-based health outcomes/migration_dates.sas7bdat')
m <- read_sas('/Volumes/projects/LGBT Project data/Registry-based health outcomes/dates_2002_2014.sas7bdat')
n <- read_sas('/Volumes/projects/LGBT Project data/Registry-based health outcomes/dates_2021.sas7bdat')


atc <- read_sas('/Volumes/LGBT Project data/Registry-based health outcomes/atc_2002_2014.sas7bdat')


inner_join( d_2021, atc, by = "lopnr" ) %>% 
  summarize( count = n() ) # 

summary(d_2021$lopnr2)

atc_2021 <- read_sas('/Volumes/LGBT Project data/Registry-based health outcomes/atc_2021.sas7bdat')
summary(atc_2021$lopnr2)

immigration_date <- read_sas("/Volumes/LGBT Project data/Registry-based health outcomes/first_immigration.sas7bdat")


str( immigration_date )
unique( nchar( immigration_date$first_immigration_date ) )
immigration_date <- immigration_date %>%
  mutate( first_immigration_date = ymd( first_immigration_date ) )
summary( immigration_date )

d_2010_complete_combined <- left_join( d_2010_complete, immigration_date, by = "lopnr" )
summary( d_2010_complete_combined$first_immigration_date )
inner_join( d_2010_complete, immigration_date, by = "lopnr" ) %>% 
  summarize( count = n() ) # 2,500 immigrated to Sweden
table( d_2010_complete_combined[ !is.na( d_2010_complete_combined$first_immigration_date ), ]$country_of_birth  )
table( d_2010_complete_combined[ is.na( d_2010_complete_combined$first_immigration_date ), ]$country_of_birth, useNA = "always"  )

d_2010_complete_combined <- d_2010_complete_combined %>%
  mutate( start_date_pdr = case_when(
    !is.na( first_immigration_date ) ~ first_immigration_date,
    is.na( first_immigration_date) & !is.na( lopnr ) ~ ymd( "20050630" ),
    TRUE ~ NA
    ) )
summary( d_2010_complete_combined$start_date_pdr )
```
